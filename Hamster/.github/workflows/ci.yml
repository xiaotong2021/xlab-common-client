name: Build iOS App

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è§¦å‘æ¡ä»¶
#   - push / PR  åˆ° main      â†’ è§¦å‘ Job1: Debug æ¨¡æ‹Ÿå™¨æ„å»ºï¼ˆæ— éœ€ç­¾åè¯ä¹¦ï¼‰
#   - push  tag  v*            â†’ è§¦å‘ Job1 + Job2: Release çœŸæœºæ„å»º + ç­¾å + IPA å¯¼å‡º
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [ main ]
    tags:     [ "v*" ]
  pull_request:
    branches: [ main ]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¨å±€å¸¸é‡ï¼ˆä¸ Xcode project.pbxproj Release é…ç½®ä¿æŒä¸€è‡´ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  XCODE_VERSION:     "15.0.1"
  PROJECT:           "Hamster.xcodeproj"
  SCHEME:            "Hamster"
  # Release é…ç½®ä¸‹å„ Target çš„ Bundle Identifier
  BUNDLE_ID_MAIN:     "com.xlab.aiime"
  BUNDLE_ID_KEYBOARD: "com.xlab.aiime.HamsterKeyboard"

jobs:
  # ============================================================================
  # Job 1 â”€â”€ Debug æ„å»ºï¼ˆiOS æ¨¡æ‹Ÿå™¨ï¼Œæ— éœ€ä»»ä½•ç­¾åè¯ä¹¦ï¼‰
  #          é€‚ç”¨åœºæ™¯ï¼šPR æ£€æŸ¥ã€æ—¥å¸¸ push éªŒè¯ä»£ç å¯ç¼–è¯‘
  # ============================================================================
  build-debug:
    name: "ğŸ”§ Debug Â· Simulator (no signing)"
    runs-on: macos-13

    steps:
      # â”€â”€ æ‹‰å–ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true   # æ‹‰å– git submodule

      # â”€â”€ åˆ‡æ¢ Xcode ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s "/Applications/Xcode_${{ env.XCODE_VERSION }}.app"

      # â”€â”€ æ ¡éªŒ Frameworksï¼ˆå·²ç›´æ¥å…¥åº“ï¼Œæ— éœ€ä¸‹è½½ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Frameworks
        run: |
          echo "â”€â”€ æ ¡éªŒ Frameworks/ ç›®å½•ä¸‹çš„ xcframework â”€â”€"
          required=(
            "boost_atomic.xcframework"
            "boost_filesystem.xcframework"
            "boost_locale.xcframework"
            "boost_regex.xcframework"
            "boost_system.xcframework"
            "icudata.xcframework"
            "icui18n.xcframework"
            "icuio.xcframework"
            "icuuc.xcframework"
            "libglog.xcframework"
            "libleveldb.xcframework"
            "libmarisa.xcframework"
            "libopencc.xcframework"
            "librime.xcframework"
            "librime-sbxlm.xcframework"
            "libyaml-cpp.xcframework"
          )
          missing=()
          for fw in "${required[@]}"; do
            if [ -d "Frameworks/$fw" ]; then
              echo "  âœ“ $fw"
            else
              echo "  âœ— $fw  â† MISSING"
              missing+=("$fw")
            fi
          done
          if [ ${#missing[@]} -ne 0 ]; then
            echo ""
            echo "âŒ ç¼ºå¤± ${#missing[@]} ä¸ª xcframework: ${missing[*]}"
            echo "   åŸ LibrimeKit releases å·²åˆ é™¤ï¼ŒFrameworks/ ç›®å½•å†…å®¹å·²ç›´æ¥æäº¤å…¥åº“ã€‚"
            echo "   è¯·ç¡®è®¤ git clone å®Œæ•´ï¼Œæˆ–æ£€æŸ¥ .gitignore æ˜¯å¦è¯¯å¿½ç•¥äº† xcframeworkã€‚"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ xcframework å°±ç»ª"

      # â”€â”€ ç¼–è¯‘è¾“å…¥æ–¹æ¡ˆï¼ˆrime-ice ç­‰ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Schemas
        run: make schema

      # â”€â”€ æ¸…ç† DerivedData é¿å…ç¼“å­˜æ±¡æŸ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      # â”€â”€ ç¼–è¯‘ Debugï¼ˆæ¨¡æ‹Ÿå™¨ï¼Œå…³é—­ç­¾åï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Debug (Simulator Â· æ— ç­¾å)
        run: |
          xcodebuild build \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      # â”€â”€ é‡ç­¾åæ³¨å…¥ entitlementsï¼ˆè§£å†³ App Group containerURL è¿”å› nilï¼‰â”€â”€â”€â”€
      # Debug æ„å»ºç¦ç”¨äº† CODE_SIGNINGï¼Œentitlements ä¸ä¼šåµŒå…¥äºŒè¿›åˆ¶ã€‚
      # ç”¨ ad-hoc ç­¾åï¼ˆæ— éœ€è¯ä¹¦ï¼‰å°† entitlements æ³¨å…¥ï¼Œä½¿æ¨¡æ‹Ÿå™¨ä¸Š App Group å¯ç”¨ã€‚
      - name: Re-sign Debug build with entitlements
        run: |
          APP_PATH=$(find build-debug -name "*.app" -not -path "*/PlugIns/*" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° .appï¼Œè·³è¿‡é‡ç­¾å"
            exit 0
          fi

          # å…ˆç­¾é”®ç›˜æ‰©å±•ï¼ˆåµŒå¥—ç­¾åå¿…é¡»ç”±å†…å‘å¤–ï¼‰
          for APPEX in "$APP_PATH"/PlugIns/*.appex; do
            [ -d "$APPEX" ] || continue
            APPEX_NAME=$(basename "$APPEX" .appex)
            APPEX_ENTITLEMENTS="HamsterKeyboard/HamsterKeyboardDebug.entitlements"
            if [ -f "$APPEX_ENTITLEMENTS" ]; then
              codesign --force --sign - --entitlements "$APPEX_ENTITLEMENTS" "$APPEX"
              echo "âœ… å·²é‡ç­¾é”®ç›˜æ‰©å±•: $APPEX_NAME"
            fi
          done

          # å†ç­¾ä¸» App
          MAIN_ENTITLEMENTS="Hamster/HamsterDebug.entitlements"
          if [ -f "$MAIN_ENTITLEMENTS" ]; then
            codesign --force --sign - --entitlements "$MAIN_ENTITLEMENTS" "$APP_PATH"
            echo "âœ… å·²é‡ç­¾ä¸» Appï¼ˆå« App Group entitlementsï¼‰"
          fi

          echo "â”€â”€ éªŒè¯åµŒå…¥çš„ entitlements â”€â”€"
          codesign -d --entitlements - "$APP_PATH" 2>&1 | head -20

      # â”€â”€ æ‰“åŒ… .app ä¸º zip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package Debug .app
        run: |
          APP_PATH=$(find build-debug -name "*.app" -not -path "*/PlugIns/*" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° .app ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          echo "ğŸ“¦ æ‰“åŒ…: $APP_PATH"
          zip -r Hamster-Debug-Simulator.zip "$APP_PATH"

      # â”€â”€ ä¸Šä¼  Debug äº§ç‰©ï¼ˆä¿ç•™ 7 å¤©ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Debug Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Hamster-Debug-Simulator
          path: Hamster-Debug-Simulator.zip
          retention-days: 7

  # ============================================================================
  # Job 2 â”€â”€ Release æ„å»ºï¼ˆiOS çœŸæœº arm64ï¼Œæ­£å¼ç­¾åï¼Œå¯¼å‡º IPAï¼‰
  #          è§¦å‘æ¡ä»¶ï¼šä»…å½“æ¨é€ v* tag æ—¶æ‰§è¡Œ
  #
  #  æ‰€éœ€ GitHub Secretsï¼ˆSettings â†’ Secrets and variables â†’ Actionsï¼‰:
  #    KEYCHAIN_PASSWORD                       ä¸´æ—¶ keychain å¯†ç ï¼ˆä»»æ„å­—ç¬¦ä¸²ï¼‰
  #    IOS_TEAM_ID                             Apple å¼€å‘è€… Team IDï¼ˆ10ä½å­—æ¯æ•°å­—ï¼‰
  #    IOS_CERTIFICATE_BASE64                  å‘å¸ƒè¯ä¹¦ .p12 çš„ base64 ç¼–ç 
  #    IOS_CERTIFICATE_PASSWORD                .p12 è¯ä¹¦çš„ä¿æŠ¤å¯†ç 
  #    IOS_PROVISIONING_PROFILE_BASE64         ä¸» App æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #    IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 é”®ç›˜æ‰©å±•æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #    IOS_EXPORT_METHOD                       å¯¼å‡ºæ–¹å¼: app-store / ad-hoc / development
  # ============================================================================
  build-release:
    name: "ğŸš€ Release Â· Device + Signing + IPA"
    runs-on: macos-13
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      # â”€â”€ æ‹‰å–ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      # â”€â”€ åˆ‡æ¢ Xcode ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s "/Applications/Xcode_${{ env.XCODE_VERSION }}.app"

      # â”€â”€ æ ¡éªŒ Frameworks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Frameworks
        run: |
          required=(
            "boost_atomic.xcframework"   "boost_filesystem.xcframework"
            "boost_locale.xcframework"   "boost_regex.xcframework"
            "boost_system.xcframework"   "icudata.xcframework"
            "icui18n.xcframework"        "icuio.xcframework"
            "icuuc.xcframework"          "libglog.xcframework"
            "libleveldb.xcframework"     "libmarisa.xcframework"
            "libopencc.xcframework"      "librime.xcframework"
            "librime-sbxlm.xcframework"  "libyaml-cpp.xcframework"
          )
          missing=()
          for fw in "${required[@]}"; do
            [ -d "Frameworks/$fw" ] && echo "  âœ“ $fw" || { echo "  âœ— $fw â† MISSING"; missing+=("$fw"); }
          done
          [ ${#missing[@]} -eq 0 ] && echo "âœ… æ‰€æœ‰ xcframework å°±ç»ª" || { echo "âŒ ç¼ºå¤±: ${missing[*]}"; exit 1; }

      # â”€â”€ ç¼–è¯‘è¾“å…¥æ–¹æ¡ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Schemas
        run: make schema

      # â”€â”€ æ¸…ç† DerivedData â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      # â”€â”€ å®‰è£…ç­¾åè¯ä¹¦ + æè¿°æ–‡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è¯´æ˜ï¼š
      #   - åˆ›å»ºä¸€ä¸ªä»…åœ¨æœ¬æ¬¡ CI ä¼šè¯ä¸­å­˜åœ¨çš„ä¸´æ—¶ keychainï¼Œé¿å…æ±¡æŸ“ç³»ç»Ÿ keychain
      #   - å°† .p12 è¯ä¹¦å¯¼å…¥ keychainï¼Œä½¿ codesign å·¥å…·å¯ä»¥ä½¿ç”¨å®ƒ
      #   - å°†ä¸¤ä¸ª .mobileprovision å®‰è£…åˆ° Provisioning Profiles ç›®å½•
      #   - æå– profile åç§°å’Œè¯ä¹¦æŒ‡çº¹ä¾›åç»­æ­¥éª¤ä½¿ç”¨
      - name: Install Certificate & Provisioning Profiles
        env:
          CERTIFICATE_BASE64:       ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD:     ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROFILE_MAIN_BASE64:      ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          PROFILE_KEYBOARD_BASE64:  ${{ secrets.IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD:        ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # â”€â”€ Step 1: åˆ›å»ºä¸´æ—¶ keychain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain  -p "$KEYCHAIN_PASSWORD" build.keychain
          # è®¾ç½® keychain è¶…æ—¶æ—¶é—´ä¸º 3600 ç§’ï¼Œé˜²æ­¢é”å®š
          security set-keychain-settings -t 3600 -u build.keychain

          # â”€â”€ Step 2: å¯¼å…¥ .p12 åˆ†å‘è¯ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          # æˆäºˆ codesign è®¿é—® keychain çš„æƒé™ï¼ˆé¿å…å¼¹å‡ºå¯†ç å¯¹è¯æ¡†ï¼‰
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # â”€â”€ Step 3: å®‰è£…ä¸» App Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo "$PROFILE_MAIN_BASE64" | base64 --decode > profile_main.mobileprovision
          MAIN_UUID=$(security cms -D -i profile_main.mobileprovision | plutil -extract UUID raw -)
          MAIN_NAME=$(security cms -D -i profile_main.mobileprovision | plutil -extract Name raw -)
          cp profile_main.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/${MAIN_UUID}.mobileprovision
          echo "ä¸» App Profile å®‰è£…æˆåŠŸ: $MAIN_NAME  (UUID: $MAIN_UUID)"

          # â”€â”€ Step 4: å®‰è£…é”®ç›˜æ‰©å±• Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "$PROFILE_KEYBOARD_BASE64" | base64 --decode > profile_keyboard.mobileprovision
          KEYBOARD_UUID=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract UUID raw -)
          KEYBOARD_NAME=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract Name raw -)
          cp profile_keyboard.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/${KEYBOARD_UUID}.mobileprovision
          echo "é”®ç›˜æ‰©å±• Profile å®‰è£…æˆåŠŸ: $KEYBOARD_NAME  (UUID: $KEYBOARD_UUID)"

          # â”€â”€ Step 5: è·å–è¯ä¹¦ç­¾åèº«ä»½ï¼ˆSHA-1ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          CERT_IDENTITY=$(
            security find-identity -v -p codesigning build.keychain \
            | grep -E "Apple Distribution|iPhone Distribution" \
            | head -1 | awk '{print $2}'
          )
          if [ -z "$CERT_IDENTITY" ]; then
            echo "âŒ æœªåœ¨ keychain ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ Distribution è¯ä¹¦ï¼Œè¯·æ£€æŸ¥ IOS_CERTIFICATE_BASE64"
            security find-identity -v build.keychain
            exit 1
          fi
          echo "è¯ä¹¦ Identity: $CERT_IDENTITY"

          # â”€â”€ Step 6: å°†å˜é‡å†™å…¥ GITHUB_ENV ä¾›åç»­æ­¥éª¤å¼•ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "MAIN_PROFILE_NAME=$MAIN_NAME"         >> $GITHUB_ENV
          echo "KEYBOARD_PROFILE_NAME=$KEYBOARD_NAME" >> $GITHUB_ENV
          echo "CERT_IDENTITY=$CERT_IDENTITY"         >> $GITHUB_ENV

      # â”€â”€ æ‰“åŒ… .xcarchiveï¼ˆå½’æ¡£é˜¶æ®µä¸ç­¾åï¼Œç­¾ååœ¨ exportArchive ç»Ÿä¸€å®Œæˆï¼‰â”€â”€â”€â”€â”€
      # åŸå› ï¼šxcodebuild archive å‘½ä»¤è¡Œæ— æ³•æ–¹ä¾¿åœ°ä¸ºä¸åŒ target æŒ‡å®šä¸åŒ profileï¼Œ
      #       é€šè¿‡ CODE_SIGNING_ALLOWED=NO è·³è¿‡å½’æ¡£ç­¾åï¼Œç”± exportArchive è¯»å–
      #       exportOptions.plist ä¸­çš„ provisioningProfiles æ˜ å°„ç»Ÿä¸€å®Œæˆç­¾åï¼Œ
      #       å¯ç²¾ç¡®æ§åˆ¶æ¯ä¸ª Bundle ID å¯¹åº”çš„ profileã€‚
      - name: Archive (unsigned)
        run: |
          xcodebuild archive \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            -archivePath Hamster.xcarchive \
            CODE_SIGNING_ALLOWED=NO

      # â”€â”€ ç”Ÿæˆ exportOptions.plist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # è¯¥æ–‡ä»¶å‘Šè¯‰ xcodebuild -exportArchiveï¼š
      #   - ç”¨å“ªç§æ–¹å¼å¯¼å‡ºï¼ˆapp-store / ad-hoc / developmentï¼‰
      #   - ç”¨å“ªä¸ªè¯ä¹¦ç­¾å
      #   - æ¯ä¸ª Bundle ID å¯¹åº”å“ªä¸ª Provisioning Profile
      - name: Generate exportOptions.plist
        run: |
          cat > exportOptions.plist << 'EXPORT_EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>EXPORT_METHOD_PLACEHOLDER</string>
              <key>teamID</key>
              <string>TEAM_ID_PLACEHOLDER</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>BUNDLE_ID_MAIN_PLACEHOLDER</key>
                  <string>MAIN_PROFILE_PLACEHOLDER</string>
                  <key>BUNDLE_ID_KEYBOARD_PLACEHOLDER</key>
                  <string>KEYBOARD_PROFILE_PLACEHOLDER</string>
              </dict>
          </dict>
          </plist>
          EXPORT_EOF

          # ç”¨çœŸå®å€¼æ›¿æ¢å ä½ç¬¦
          sed -i'' \
            -e "s|EXPORT_METHOD_PLACEHOLDER|${{ secrets.IOS_EXPORT_METHOD }}|g" \
            -e "s|TEAM_ID_PLACEHOLDER|${{ secrets.IOS_TEAM_ID }}|g" \
            -e "s|BUNDLE_ID_MAIN_PLACEHOLDER|${{ env.BUNDLE_ID_MAIN }}|g" \
            -e "s|MAIN_PROFILE_PLACEHOLDER|$MAIN_PROFILE_NAME|g" \
            -e "s|BUNDLE_ID_KEYBOARD_PLACEHOLDER|${{ env.BUNDLE_ID_KEYBOARD }}|g" \
            -e "s|KEYBOARD_PROFILE_PLACEHOLDER|$KEYBOARD_PROFILE_NAME|g" \
            exportOptions.plist

          echo "â”€â”€ æœ€ç»ˆ exportOptions.plist â”€â”€"
          cat exportOptions.plist

      # â”€â”€ å¯¼å‡º IPAï¼ˆåŒæ—¶å®Œæˆç­¾åï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath Hamster.xcarchive \
            -exportPath  Hamster-Release \
            -exportOptionsPlist exportOptions.plist
          echo "â”€â”€ å¯¼å‡ºäº§ç‰© â”€â”€"
          ls -lh Hamster-Release/

      # â”€â”€ ä¸Šä¼  IPA äº§ç‰©ï¼ˆä¿ç•™ 30 å¤©ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Release IPA
        uses: actions/upload-artifact@v4
        with:
          name: Hamster-Release-IPA
          path: Hamster-Release/*.ipa
          retention-days: 30

      # â”€â”€ æ‰“åŒ… xcarchiveï¼ˆå¯åœ¨ Xcode ä¸­é‡æ–°å¯¼å‡ºæˆ– resignï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package xcarchive
        run: tar -acf Hamster.xcarchive.tgz Hamster.xcarchive

      - name: Upload xcarchive Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Hamster-xcarchive
          path: Hamster.xcarchive.tgz
          retention-days: 30

      # â”€â”€ åˆ›å»º GitHub Releaseï¼ˆä»… tag push æ—¶ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "ä»“è¾“å…¥æ³• ${{ github.ref_name }}"
          body: |
            ## ä»“è¾“å…¥æ³• ${{ github.ref_name }}

            ### ğŸ“¦ å®‰è£…æ–¹å¼
            | å¯¼å‡ºæ–¹å¼ | å®‰è£…é€”å¾„ |
            |----------|---------|
            | `app-store` | TestFlight å†…æµ‹ / App Store æ­£å¼å‘å¸ƒ |
            | `ad-hoc`    | AltStore / Sideloadly / iOS App Installer ç­‰å·¥å…·ä¾§è½½ |
            | `development` | Xcode ç›´æ¥å®‰è£…åˆ°å·²æ³¨å†Œçš„å¼€å‘è®¾å¤‡ |

            ### ğŸ“ æ–‡ä»¶è¯´æ˜
            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `Hamster-*.ipa` | iOS å®‰è£…åŒ… |
            | `Hamster.xcarchive.tgz` | Xcode å½’æ¡£ï¼Œå¯åœ¨ Xcode Organizer ä¸­é‡æ–°å¯¼å‡ºæˆ– resign |

            ### ğŸ“ å˜æ›´å†…å®¹
            è¯¦è§ [Commits](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          draft: false
          prerelease: false
          files: |
            Hamster-Release/*.ipa
            Hamster.xcarchive.tgz
