name: Build iOS App

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* tag æ—¶è§¦å‘æ„å»º
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    tags:
      - "v*"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¨å±€å¸¸é‡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  XCODE_VERSION: "15.0.1"
  PROJECT:       "Hamster.xcodeproj"
  SCHEME:        "Hamster"
  HAMSTER_DIR:   "Hamster"

jobs:
  # ============================================================================
  # Job 1 â”€â”€ è¯»å–æ„å»ºé…ç½®ï¼ˆä»…ä»é…ç½®æ–‡ä»¶è¯»å–ï¼Œä¸æ¶‰åŠ secretsï¼‰
  # ============================================================================
  prepare:
    name: Prepare Build Configuration
    runs-on: ubuntu-latest
    outputs:
      need_debug: ${{ steps.config.outputs.need_debug }}
      app_version: ${{ steps.config.outputs.app_version }}
      app_display_name: ${{ steps.config.outputs.app_display_name }}
      cfg_bundle_id: ${{ steps.config.outputs.cfg_bundle_id }}
      cfg_team_id: ${{ steps.config.outputs.cfg_team_id }}
      cfg_export_method: ${{ steps.config.outputs.cfg_export_method }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Read build configuration
        id: config
        run: |
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          CONFIG_FILE="assets/$APP_NAME/app.cfg"

          NEED_DEBUG=$(grep '^needDebug=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          APP_VERSION=$(grep '^appVersion=' $CONFIG_FILE | cut -d'=' -f2)
          APP_DISPLAY_NAME=$(grep '^appDisplayName=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_BUNDLE_ID=$(grep '^appId=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_TEAM_ID=$(grep '^iosTeamId=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_EXPORT_METHOD=$(grep '^iosExportMethod=' $CONFIG_FILE | cut -d'=' -f2)

          echo "need_debug=${NEED_DEBUG:-false}"             >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION"                    >> $GITHUB_OUTPUT
          echo "app_display_name=$APP_DISPLAY_NAME"          >> $GITHUB_OUTPUT
          echo "cfg_bundle_id=$CFG_BUNDLE_ID"                >> $GITHUB_OUTPUT
          echo "cfg_team_id=$CFG_TEAM_ID"                    >> $GITHUB_OUTPUT
          echo "cfg_export_method=${CFG_EXPORT_METHOD:-app-store}" >> $GITHUB_OUTPUT

          echo "Need Debug: ${NEED_DEBUG:-false}"
          echo "App Version: $APP_VERSION"
          echo "App Display Name: $APP_DISPLAY_NAME"
          echo "Bundle ID (cfg): $CFG_BUNDLE_ID"
          echo "Team ID (cfg): $CFG_TEAM_ID"
          echo "Export Method (cfg): ${CFG_EXPORT_METHOD:-app-store}"

  # ============================================================================
  # Job 2 â”€â”€ iOS æ„å»ºï¼ˆDebug + Releaseï¼‰+ GitHub Release
  #
  #  æ‰€éœ€ GitHub Secretsï¼ˆå¿…å¡«ï¼‰:
  #    KEYCHAIN_PASSWORD                        ä¸´æ—¶ keychain å¯†ç ï¼ˆä»»æ„å­—ç¬¦ä¸²ï¼‰
  #    IOS_CERTIFICATE_BASE64                   å‘å¸ƒè¯ä¹¦ .p12 çš„ base64 ç¼–ç 
  #    IOS_CERTIFICATE_PASSWORD                 .p12 è¯ä¹¦çš„ä¿æŠ¤å¯†ç 
  #    IOS_MAIN_PROVISIONING_PROFILE_BASE64          ä¸» App æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #    TOKEN                                    GitHub Tokenï¼ˆç”¨äº Releaseï¼‰
  #
  #  å¯é€‰ GitHub Secretsï¼ˆæœªè®¾ç½®åˆ™è·³è¿‡ï¼‰:
  #    IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 é”®ç›˜æ‰©å±•æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #
  #  å¯é€‰ GitHub Secretsï¼ˆä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ï¼Œæœªè®¾ç½®åˆ™å›é€€åˆ° app.cfgï¼‰:
  #    IOS_BUNDLE_ID            â†’ Bundle IDï¼ˆä¸» Appï¼‰ï¼Œå›é€€: appId
  #    IOS_BUNDLE_ID_KEYBOARD   â†’ Bundle IDï¼ˆé”®ç›˜æ‰©å±•ï¼‰ï¼Œå›é€€: ${BUNDLE_ID}.HamsterKeyboard
  #    IOS_TEAM_ID              â†’ Apple å¼€å‘è€… Team IDï¼Œå›é€€: iosTeamId
  #    IOS_EXPORT_METHOD        â†’ å¯¼å‡ºæ–¹å¼ï¼Œå›é€€: iosExportMethod
  # ============================================================================
  build:
    name: Build Hamster iOS App
    needs: prepare
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      # â”€â”€ æ‹‰å–ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      # â”€â”€ åˆ‡æ¢ Xcode ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s "/Applications/Xcode_${{ env.XCODE_VERSION }}.app"

      # â”€â”€ è§£ææœ€ç»ˆæ„å»ºå‚æ•°ï¼ˆSecrets ä¼˜å…ˆï¼Œå›é€€åˆ°é…ç½®æ–‡ä»¶ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resolve build parameters
        env:
          SECRET_BUNDLE_ID:          ${{ secrets.IOS_BUNDLE_ID }}
          SECRET_BUNDLE_ID_KEYBOARD: ${{ secrets.IOS_BUNDLE_ID_KEYBOARD }}
          SECRET_TEAM_ID:            ${{ secrets.IOS_TEAM_ID }}
          SECRET_EXPORT_METHOD:      ${{ secrets.IOS_EXPORT_METHOD }}
          CFG_BUNDLE_ID:             ${{ needs.prepare.outputs.cfg_bundle_id }}
          CFG_TEAM_ID:               ${{ needs.prepare.outputs.cfg_team_id }}
          CFG_EXPORT_METHOD:         ${{ needs.prepare.outputs.cfg_export_method }}
        run: |
          BUNDLE_ID=${SECRET_BUNDLE_ID:-$CFG_BUNDLE_ID}
          BUNDLE_ID_KEYBOARD=${SECRET_BUNDLE_ID_KEYBOARD:-${BUNDLE_ID}.HamsterKeyboard}
          TEAM_ID=${SECRET_TEAM_ID:-$CFG_TEAM_ID}
          EXPORT_METHOD=${SECRET_EXPORT_METHOD:-$CFG_EXPORT_METHOD}

          echo "BUNDLE_ID=$BUNDLE_ID"                   >> $GITHUB_ENV
          echo "BUNDLE_ID_KEYBOARD=$BUNDLE_ID_KEYBOARD" >> $GITHUB_ENV
          echo "TEAM_ID=$TEAM_ID"                       >> $GITHUB_ENV
          echo "EXPORT_METHOD=$EXPORT_METHOD"            >> $GITHUB_ENV

          echo "Bundle ID: $BUNDLE_ID (source: $([ -n "$SECRET_BUNDLE_ID" ] && echo 'secrets' || echo 'app.cfg'))"
          echo "Bundle ID Keyboard: $BUNDLE_ID_KEYBOARD (source: $([ -n "$SECRET_BUNDLE_ID_KEYBOARD" ] && echo 'secrets' || echo 'derived'))"
          echo "Team ID: $TEAM_ID (source: $([ -n "$SECRET_TEAM_ID" ] && echo 'secrets' || echo 'app.cfg'))"
          echo "Export Method: $EXPORT_METHOD (source: $([ -n "$SECRET_EXPORT_METHOD" ] && echo 'secrets' || echo 'app.cfg'))"

      # â”€â”€ æ ¡éªŒ Frameworks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Frameworks
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          required=(
            "boost_atomic.xcframework"   "boost_filesystem.xcframework"
            "boost_locale.xcframework"   "boost_regex.xcframework"
            "boost_system.xcframework"   "icudata.xcframework"
            "icui18n.xcframework"        "icuio.xcframework"
            "icuuc.xcframework"          "libglog.xcframework"
            "libleveldb.xcframework"     "libmarisa.xcframework"
            "libopencc.xcframework"      "librime.xcframework"
            "librime-sbxlm.xcframework"  "libyaml-cpp.xcframework"
          )
          missing=()
          for fw in "${required[@]}"; do
            [ -d "Frameworks/$fw" ] && echo "  âœ“ $fw" || { echo "  âœ— $fw â† MISSING"; missing+=("$fw"); }
          done
          [ ${#missing[@]} -eq 0 ] && echo "âœ… æ‰€æœ‰ xcframework å°±ç»ª" || { echo "âŒ ç¼ºå¤±: ${missing[*]}"; exit 1; }

      # â”€â”€ ç¼–è¯‘è¾“å…¥æ–¹æ¡ˆï¼ˆrime-ice ç­‰ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Schemas
        working-directory: ${{ env.HAMSTER_DIR }}
        run: make schema

      # â”€â”€ æ¸…ç† DerivedData â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      # ========== iOS Debug æ„å»ºï¼ˆæ¨¡æ‹Ÿå™¨ï¼Œad-hoc ç­¾åï¼‰ ==========
      # å¿…é¡»ä½¿ç”¨ CODE_SIGN_IDENTITY="-"ï¼ˆad-hocï¼‰è®© Xcode åœ¨æ„å»ºé˜¶æ®µå¤„ç†ç­¾åå’Œ
      # App Group æ³¨å†Œã€‚è‹¥æ”¹ç”¨ CODE_SIGNING_ALLOWED=NO + äº‹å codesign è¡¥ç­¾ï¼Œ
      # CoreSimulator ä¸ä¼šæ³¨å†Œ App Groupï¼Œå¯¼è‡´ UserDefaults(suiteName:) è½ç›˜åˆ°
      # å„è¿›ç¨‹ç§æœ‰æ²™ç›’è€Œéå…±äº«å®¹å™¨ï¼Œä¸¤ä¸ªè¿›ç¨‹æ— æ³•å…±äº«æ•°æ®ã€‚
      - name: Build Debug (Simulator)
        if: needs.prepare.outputs.need_debug == 'true'
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild build \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_REQUIRED=YES

      - name: Package Debug .app
        if: needs.prepare.outputs.need_debug == 'true'
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          APP_PATH=$(find build-debug -name "*.app" -not -path "*/PlugIns/*" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° .app ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          echo "ğŸ“¦ æ‰“åŒ…: $APP_PATH"
          zip -r Hamster-Debug-Simulator.zip "$APP_PATH"

      # ========== iOS Release æ„å»ºï¼ˆçœŸæœºç­¾åï¼‰ ==========
      - name: Install Certificate & Provisioning Profiles
        env:
          CERTIFICATE_BASE64:      ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD:    ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROFILE_MAIN_BASE64:     ${{ secrets.IOS_MAIN_PROVISIONING_PROFILE_BASE64 }}
          PROFILE_KEYBOARD_BASE64: ${{ secrets.IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD:       ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # â”€â”€ åˆ›å»ºä¸´æ—¶ keychain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain  -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # â”€â”€ å¯¼å…¥ .p12 è¯ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # â”€â”€ å®‰è£…ä¸» App Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo "$PROFILE_MAIN_BASE64" | base64 --decode > profile_main.mobileprovision
          MAIN_UUID=$(security cms -D -i profile_main.mobileprovision | plutil -extract UUID raw -)
          MAIN_NAME=$(security cms -D -i profile_main.mobileprovision | plutil -extract Name raw -)
          cp profile_main.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/${MAIN_UUID}.mobileprovision
          echo "ä¸» App Profile: $MAIN_NAME (UUID: $MAIN_UUID)"

          # â”€â”€ å®‰è£…é”®ç›˜æ‰©å±• Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # éœ€è¦ç‹¬ç«‹çš„æ˜¾å¼ Profileï¼ˆå« App Groups èƒ½åŠ›ï¼‰ï¼Œæœªé…ç½®æ—¶å›é€€åˆ°ä¸» App Profile
          if [ -n "$PROFILE_KEYBOARD_BASE64" ]; then
            echo "$PROFILE_KEYBOARD_BASE64" | base64 --decode > profile_keyboard.mobileprovision
            if security cms -D -i profile_keyboard.mobileprovision > /dev/null 2>&1; then
              KEYBOARD_UUID=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract UUID raw -)
              KEYBOARD_NAME=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract Name raw -)
              cp profile_keyboard.mobileprovision \
                ~/Library/MobileDevice/Provisioning\ Profiles/${KEYBOARD_UUID}.mobileprovision
              echo "é”®ç›˜æ‰©å±• Profileï¼ˆç‹¬ç«‹ï¼‰: $KEYBOARD_NAME (UUID: $KEYBOARD_UUID)"
            else
              echo "âš ï¸  é”®ç›˜æ‰©å±• Profile è§£ç å¤±è´¥ï¼Œå›é€€ä½¿ç”¨ä¸» App Profile"
              KEYBOARD_NAME="$MAIN_NAME"
            fi
          else
            KEYBOARD_NAME="$MAIN_NAME"
            echo "â„¹ï¸  é”®ç›˜æ‰©å±•å¤ç”¨ä¸» App Profile: $KEYBOARD_NAME"
          fi

          # â”€â”€ è·å–è¯ä¹¦ç­¾åèº«ä»½ï¼ˆSHA-1ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          CERT_IDENTITY=$(
            security find-identity -v -p codesigning build.keychain \
            | grep -E "Apple Distribution|iPhone Distribution" \
            | head -1 | awk '{print $2}'
          )
          if [ -z "$CERT_IDENTITY" ]; then
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ Distribution è¯ä¹¦"
            security find-identity -v build.keychain
            exit 1
          fi
          echo "è¯ä¹¦ Identity: $CERT_IDENTITY"

          # â”€â”€ å†™å…¥ GITHUB_ENV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "MAIN_PROFILE_NAME=$MAIN_NAME"         >> $GITHUB_ENV
          echo "KEYBOARD_PROFILE_NAME=$KEYBOARD_NAME" >> $GITHUB_ENV
          echo "CERT_IDENTITY=$CERT_IDENTITY"         >> $GITHUB_ENV

      # å½’æ¡£é˜¶æ®µä¸ç­¾åï¼ˆé¿å… per-target Profile åŒ¹é…é—®é¢˜ï¼‰ï¼Œ
      # ä½†å½’æ¡£åç”¨ ad-hoc ç­¾åå°† entitlements åµŒå…¥äºŒè¿›åˆ¶ï¼Œç¡®ä¿ exportArchive èƒ½æ­£ç¡®åŒ…å« App Groups ç­‰èƒ½åŠ›ã€‚
      - name: Archive (unsigned)
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild archive \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            -archivePath Hamster.xcarchive \
            CODE_SIGNING_ALLOWED=NO

      - name: Embed entitlements into archive
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          ARCHIVE_APP="Hamster.xcarchive/Products/Applications/Hamster.app"
          if [ ! -d "$ARCHIVE_APP" ]; then
            echo "âŒ æœªæ‰¾åˆ° archive ä¸­çš„ .app"
            exit 1
          fi

          # å…ˆç­¾é”®ç›˜æ‰©å±•ï¼ˆåµŒå¥—ç­¾åå¿…é¡»ç”±å†…å‘å¤–ï¼‰
          for APPEX in "$ARCHIVE_APP"/PlugIns/*.appex; do
            [ -d "$APPEX" ] || continue
            APPEX_NAME=$(basename "$APPEX" .appex)
            APPEX_ENTITLEMENTS="HamsterKeyboard/HamsterKeyboard.entitlements"
            if [ -f "$APPEX_ENTITLEMENTS" ]; then
              codesign --force --sign - --entitlements "$APPEX_ENTITLEMENTS" "$APPEX"
              echo "âœ… å·²åµŒå…¥é”®ç›˜æ‰©å±• entitlements: $APPEX_NAME"
            fi
          done

          # å†ç­¾ä¸» App
          MAIN_ENTITLEMENTS="Hamster/Hamster.entitlements"
          if [ -f "$MAIN_ENTITLEMENTS" ]; then
            codesign --force --sign - --entitlements "$MAIN_ENTITLEMENTS" "$ARCHIVE_APP"
            echo "âœ… å·²åµŒå…¥ä¸» App entitlements"
          fi

          # éªŒè¯ entitlements å·²åµŒå…¥
          echo "â”€â”€ éªŒè¯ archive ä¸­çš„ entitlements â”€â”€"
          echo "ä¸» App:"
          codesign -d --entitlements - "$ARCHIVE_APP" 2>&1 | head -30
          echo ""
          echo "é”®ç›˜æ‰©å±•:"
          APPEX_PATH=$(find "$ARCHIVE_APP/PlugIns" -name "*.appex" -type d | head -1)
          if [ -n "$APPEX_PATH" ]; then
            codesign -d --entitlements - "$APPEX_PATH" 2>&1 | head -15
          fi

      - name: Generate exportOptions.plist
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${EXPORT_METHOD}</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${MAIN_PROFILE_NAME}</string>
              </dict>
          </dict>
          </plist>
          EOF

          # æ·»åŠ é”®ç›˜æ‰©å±• Bundle ID â†’ Profile æ˜ å°„
          /usr/libexec/PlistBuddy -c \
            "Add :provisioningProfiles:${BUNDLE_ID_KEYBOARD} string ${KEYBOARD_PROFILE_NAME}" \
            exportOptions.plist

          echo "â”€â”€ exportOptions.plist â”€â”€"
          cat exportOptions.plist

      - name: Export IPA
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild -exportArchive \
            -archivePath Hamster.xcarchive \
            -exportPath  Hamster-Release \
            -exportOptionsPlist exportOptions.plist
          echo "â”€â”€ å¯¼å‡ºäº§ç‰© â”€â”€"
          ls -lh Hamster-Release/

      - name: Verify App Group entitlements in IPA
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          IPA_PATH=$(find Hamster-Release -name "*.ipa" -type f | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° IPAï¼Œè·³è¿‡ entitlements éªŒè¯"
            exit 0
          fi

          TMPDIR=$(mktemp -d)
          unzip -q "$IPA_PATH" -d "$TMPDIR"

          APP_PATH=$(find "$TMPDIR/Payload" -name "*.app" -maxdepth 1 -type d | head -1)
          EXPECTED_GROUP="group.com.xlab.aiime"

          echo "â”€â”€ éªŒè¯ä¸» App entitlements â”€â”€"
          codesign -d --entitlements - "$APP_PATH" 2>&1 | head -30
          if codesign -d --entitlements - "$APP_PATH" 2>&1 | grep -q "$EXPECTED_GROUP"; then
            echo "âœ… ä¸» App åŒ…å« App Group: $EXPECTED_GROUP"
          else
            echo "âŒ ä¸» App ç¼ºå°‘ App Group: $EXPECTED_GROUP"
            echo ""
            echo "ä¿®å¤æ–¹æ³•ï¼š"
            echo "  1. Apple Developer Portal â†’ Identifiers â†’ ${BUNDLE_ID} â†’ å¯ç”¨ App Groups â†’ æ·»åŠ  $EXPECTED_GROUP"
            echo "  2. é‡æ–°ç”Ÿæˆ Provisioning Profile å¹¶æ›´æ–° GitHub Secret: IOS_MAIN_PROVISIONING_PROFILE_BASE64"
            exit 1
          fi

          echo ""
          echo "â”€â”€ éªŒè¯é”®ç›˜æ‰©å±• entitlements â”€â”€"
          APPEX_PATH=$(find "$APP_PATH/PlugIns" -name "*.appex" -type d | head -1)
          if [ -n "$APPEX_PATH" ]; then
            codesign -d --entitlements - "$APPEX_PATH" 2>&1 | head -30
            if codesign -d --entitlements - "$APPEX_PATH" 2>&1 | grep -q "$EXPECTED_GROUP"; then
              echo "âœ… é”®ç›˜æ‰©å±•åŒ…å« App Group: $EXPECTED_GROUP"
            else
              echo "âŒ é”®ç›˜æ‰©å±•ç¼ºå°‘ App Group: $EXPECTED_GROUP"
              echo ""
              echo "ä¿®å¤æ–¹æ³•ï¼š"
              echo "  1. Apple Developer Portal â†’ Identifiers â†’ ${BUNDLE_ID_KEYBOARD} â†’ å¯ç”¨ App Groups â†’ æ·»åŠ  $EXPECTED_GROUP"
              echo "  2. é‡æ–°ç”Ÿæˆé”®ç›˜æ‰©å±• Provisioning Profile å¹¶æ›´æ–° GitHub Secret: IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64"
              exit 1
            fi
          fi

          rm -rf "$TMPDIR"
          echo ""
          echo "âœ… App Group entitlements éªŒè¯é€šè¿‡"

      # ========== å‡†å¤‡å‘å¸ƒäº§ç‰© ==========
      - name: Prepare release artifacts
        run: |
          mkdir -p ./artifacts

          # Debug .app zip
          if [ "${{ needs.prepare.outputs.need_debug }}" = "true" ]; then
            if [ -f "${{ env.HAMSTER_DIR }}/Hamster-Debug-Simulator.zip" ]; then
              cp "${{ env.HAMSTER_DIR }}/Hamster-Debug-Simulator.zip" \
                "./artifacts/Hamster-${{ needs.prepare.outputs.app_version }}-Debug-Simulator.zip"
              echo "å·²åˆ›å»º: Hamster-${{ needs.prepare.outputs.app_version }}-Debug-Simulator.zip"
            fi
          fi

          # Release IPA
          find "${{ env.HAMSTER_DIR }}/Hamster-Release" -name "*.ipa" -type f 2>/dev/null | while read file; do
            cp "$file" "./artifacts/Hamster-${{ needs.prepare.outputs.app_version }}.ipa"
            echo "å·²å¤åˆ¶: Hamster-${{ needs.prepare.outputs.app_version }}.ipa"
          done

          echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
          ls -lR ./artifacts/

      # ========== GitHub Release ==========
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: "${{ needs.prepare.outputs.app_display_name }} ${{ github.ref_name }}"
          body: |
            ## ${{ needs.prepare.outputs.app_display_name }} ${{ github.ref_name }}

            **ç‰ˆæœ¬å· / Version**: ${{ needs.prepare.outputs.app_version }}

            ### ğŸ“¦ å®‰è£…æ–¹å¼
            | å¯¼å‡ºæ–¹å¼ | å®‰è£…é€”å¾„ |
            |----------|---------|
            | `app-store` | TestFlight å†…æµ‹ / App Store æ­£å¼å‘å¸ƒ |
            | `ad-hoc`    | AltStore / Sideloadly ç­‰å·¥å…·ä¾§è½½ |
            | `development` | Xcode ç›´æ¥å®‰è£…åˆ°å·²æ³¨å†Œçš„å¼€å‘è®¾å¤‡ |

            ### ğŸ“ å˜æ›´å†…å®¹
            è¯¦è§ [Commits](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          draft: false
          prerelease: false
          files: |
            ./artifacts/Hamster-*.ipa
            ./artifacts/Hamster-*-Debug-Simulator.zip
          fail_on_unmatched_files: false
