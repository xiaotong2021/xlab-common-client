name: Build WebView App

on:
  push:
    tags:
      - "v*" # Trigger when pushing tags starting with v, e.g. v1.0.0

jobs:
  prepare:
    name: Prepare Build Configuration
    runs-on: ubuntu-latest
    outputs:
      build_android: ${{ steps.config.outputs.build_android }}
      build_ios: ${{ steps.config.outputs.build_ios }}
      need_debug: ${{ steps.config.outputs.need_debug }}
      app_version: ${{ steps.config.outputs.app_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Read build configuration
        id: config
        run: |
          # è¯»å– build.app
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          echo "App Name: $APP_NAME"
          
          # è¯»å–é…ç½®æ–‡ä»¶
          CONFIG_FILE="assets/$APP_NAME/app.cfg"
          
          # æå–é…ç½®å€¼
          BUILD_ANDROID=$(grep '^buildAndroid=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          BUILD_IOS=$(grep '^buildIOS=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          NEED_DEBUG=$(grep '^needDebug=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          APP_VERSION=$(grep '^appVersion=' $CONFIG_FILE | cut -d'=' -f2)
          
          # è®¾ç½®é»˜è®¤å€¼
          NEED_DEBUG=${NEED_DEBUG:-false}
          
          echo "build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "build_ios=$BUILD_IOS" >> $GITHUB_OUTPUT
          echo "need_debug=$NEED_DEBUG" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          
          echo "Build Android: $BUILD_ANDROID"
          echo "Build iOS: $BUILD_IOS"
          echo "Need Debug: $NEED_DEBUG"
          echo "App Version: $APP_VERSION"

  build:
    name: Build iOS and Android Apps
    needs: prepare
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          pip install Pillow PyJWT requests cryptography

      - name: Configure project
        run: |
          python3 scripts/build_config.py ${{ github.workspace }}

      - name: Verify build configuration
        run: |
          chmod +x scripts/verify_build.sh
          bash scripts/verify_build.sh

      # ========== iOS æ„å»º ==========
      - name: Setup Xcode
        if: needs.prepare.outputs.build_ios == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Create exportOptions.plist placeholder
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # exportOptions.plist å°†åœ¨è¯ä¹¦å®‰è£…ååˆ›å»º
          echo "exportOptions.plist will be created after certificate installation"

      - name: Install certificates and provisioning profiles
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # åˆ›å»ºä¸´æ—¶keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # å¯¼å…¥è¯ä¹¦
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # å®‰è£…provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          
          # è·å– Profile UUIDï¼ˆä½¿ç”¨ security å‘½ä»¤è§£æï¼‰
          PROFILE_UUID=$(security cms -D -i profile.mobileprovision | plutil -extract UUID raw -)
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "Installed Profile UUID: $PROFILE_UUID"
          
          # è·å– Profile åç§°ï¼ˆç”¨äº exportOptions.plistï¼‰
          PROFILE_NAME=$(security cms -D -i profile.mobileprovision | plutil -extract Name raw -)
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "Profile Name: $PROFILE_NAME"
          
          # ä» app.cfg è¯»å–å®é™…çš„ Bundle IDï¼ˆæ”¯æŒé€šé…ç¬¦ Profileï¼‰
          # ä¸å†ä» Profile ä¸­æå–ï¼Œå› ä¸º Profile å¯èƒ½æ˜¯é€šé…ç¬¦ï¼ˆå¦‚ com.xlab.*ï¼‰
          APP_NAME=$(cat assets/build.app | grep appName | cut -d'=' -f2)
          BUNDLE_ID=$(grep "^appId=" assets/${APP_NAME}/app.cfg | cut -d'=' -f2)
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
          echo "Bundle ID from app.cfg: $BUNDLE_ID"
          
          # éªŒè¯ Profile çš„ App IDï¼ˆç”¨äºè°ƒè¯•ï¼‰
          PROFILE_APP_ID=$(security cms -D -i profile.mobileprovision | plutil -extract Entitlements.application-identifier raw - | sed 's/^[^.]*\.//')
          echo "Profile App ID: $PROFILE_APP_ID"
          
          # å¤åˆ¶ Profile åˆ°æ­£ç¡®çš„ä½ç½®ï¼ˆä½¿ç”¨ UUID ä½œä¸ºæ–‡ä»¶åï¼‰
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          
          # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ç­¾åèº«ä»½ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          
          # è·å–è¯ä¹¦èº«ä»½ï¼ˆSHA-1 hashï¼‰
          CERT_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Apple Distribution" | head -1 | awk '{print $2}')
          echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
          echo "Certificate Identity: $CERT_IDENTITY"
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ° Apple Distributionï¼Œå°è¯•æŸ¥æ‰¾ iPhone Distribution
          if [ -z "$CERT_IDENTITY" ]; then
            CERT_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "iPhone Distribution" | head -1 | awk '{print $2}')
            echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
            echo "Certificate Identity (iPhone): $CERT_IDENTITY"
          fi
          
          # è®¾ç½® export method å’Œ team ID ä¸º shell å˜é‡
          EXPORT_METHOD="${{ secrets.IOS_EXPORT_METHOD }}"
          if [ -z "$EXPORT_METHOD" ]; then
            EXPORT_METHOD="app-store"
          fi
          TEAM_ID="${{ secrets.IOS_TEAM_ID }}"
          
          echo "Export Method: $EXPORT_METHOD"
          echo "Team ID: $TEAM_ID"
          
          # åˆ›å»º exportOptions.plistï¼ˆä½¿ç”¨ Profile åç§°æ”¯æŒé€šé…ç¬¦ï¼‰
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${EXPORT_METHOD}</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${PROFILE_NAME}</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          echo "=== Created exportOptions.plist ==="
          cat ios/exportOptions.plist
          echo "=== End of exportOptions.plist ==="

      - name: Build iOS app (Debug)
        if: needs.prepare.outputs.build_ios == 'true' && needs.prepare.outputs.need_debug == 'true'
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Build iOS app (Release)
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build-release \
            -archivePath build-release/WebViewApp.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="${CERT_IDENTITY}" \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_NAME}" \
            archive
          
          # å¯¼å‡ºIPA
          xcodebuild -exportArchive \
            -archivePath build-release/WebViewApp.xcarchive \
            -exportPath build-release/output \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates

      - name: Generate App Screenshots
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # è¯»å–é…ç½®
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          CONFIG_FILE="assets/$APP_NAME/app.cfg"
          ENABLE_SCREENSHOT=$(grep '^enableScreenshotGeneration=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          
          if [ "$ENABLE_SCREENSHOT" = "true" ]; then
            echo "ğŸ“¸ ç”Ÿæˆ App Store æˆªå›¾..."
            python3 scripts/generate_app_screenshots.py ${{ github.workspace }}
          else
            echo "â„¹ï¸  æˆªå›¾ç”Ÿæˆå·²ç¦ç”¨ (enableScreenshotGeneration=false)"
          fi
        continue-on-error: true

      - name: Setup App Store Connect API Key
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # åˆ›å»ºç§é’¥ç›®å½•
          mkdir -p ~/.appstoreconnect/private_keys
          
          # è§£ç  API å¯†é’¥å¹¶ä¿å­˜åˆ°æ­£ç¡®çš„ä½ç½®å’Œæ–‡ä»¶å
          echo "${{ secrets.APP_STORE_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_API_KEY_ID }}.p8
          
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_API_KEY_ID }}.p8
          
          echo "âœ… API å¯†é’¥å·²å‡†å¤‡"

      - name: Upload to TestFlight
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # ä¸Šä¼  IPA
          xcrun altool --upload-app \
            --file ios/build-release/output/WebViewApp.ipa \
            --type ios \
            --apiKey ${{ secrets.APP_STORE_API_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_API_ISSUER_ID }}

      - name: Update App Store Connect Metadata
        if: needs.prepare.outputs.build_ios == 'true'
        run: |
          # è¯»å–é…ç½®
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          CONFIG_FILE="assets/$APP_NAME/app.cfg"
          ENABLE_ASC=$(grep '^enableAppStoreConnect=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          
          if [ "$ENABLE_ASC" = "true" ]; then
            echo "ğŸ”„ App Store Connect å…ƒæ•°æ®æ›´æ–°å·²å¯ç”¨"
            echo "ğŸ“ TestFlight ä¸Šä¼ å®Œæˆï¼Œç°åœ¨æ›´æ–°åº”ç”¨å…ƒæ•°æ®..."
            
            # è¿è¡Œ App Store Connect å…ƒæ•°æ®æ›´æ–°è„šæœ¬
            # è¿™å°†æ›´æ–°ç°æœ‰åº”ç”¨çš„å…ƒæ•°æ®å’Œæˆªå›¾
            python3 scripts/app_store_connect.py ${{ github.workspace }}
          else
            echo "â„¹ï¸  App Store Connect å…ƒæ•°æ®æ›´æ–°å·²ç¦ç”¨ (enableAppStoreConnect=false)"
            echo "æç¤º: å¦‚éœ€è‡ªåŠ¨æ›´æ–°åº”ç”¨å…ƒæ•°æ®ï¼Œè¯·åœ¨ app.cfg ä¸­è®¾ç½® enableAppStoreConnect=true"
          fi
        env:
          APP_STORE_API_KEY_ID: ${{ secrets.APP_STORE_API_KEY_ID }}
          APP_STORE_API_ISSUER_ID: ${{ secrets.APP_STORE_API_ISSUER_ID }}
        continue-on-error: true

      # ========== Android æ„å»º ==========
      - name: Set up JDK 17
        if: needs.prepare.outputs.build_android == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        if: needs.prepare.outputs.build_android == 'true'
        run: chmod +x android/gradlew
        working-directory: ./

      - name: Clean Android build
        if: needs.prepare.outputs.build_android == 'true'
        run: ./gradlew clean
        working-directory: ./android

      - name: Decode and create keystore
        if: needs.prepare.outputs.build_android == 'true'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/${{ secrets.ANDROID_KEYSTORE_FILE || 'devdroid.jks' }}
        working-directory: ./

      - name: Build Android Debug APK
        if: needs.prepare.outputs.build_android == 'true' && needs.prepare.outputs.need_debug == 'true'
        run: ./gradlew assembleDebug
        working-directory: ./android

      - name: Build Android Release APK
        if: needs.prepare.outputs.build_android == 'true'
        run: ./gradlew assembleRelease
        working-directory: ./android
        env:
          KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE || 'devdroid.jks' }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # ========== å‡†å¤‡å‘å¸ƒ ==========
      - name: Prepare release artifacts
        run: |
          mkdir -p ./artifacts
          
          # è¯»å–åº”ç”¨åç§°
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          
          # å¤„ç† Android æ–‡ä»¶
          if [ "${{ needs.prepare.outputs.build_android }}" = "true" ]; then
            echo "ğŸ“¦ å‡†å¤‡ Android å‘å¸ƒæ–‡ä»¶..."
            mkdir -p ./artifacts/android
            
            # å¤„ç† Debug APK
            if [ "${{ needs.prepare.outputs.need_debug }}" = "true" ]; then
              find android/app/build/outputs/apk/debug -name "*.apk" -type f 2>/dev/null | while read file; do
                base=$(basename "$file")
                cp "$file" "./artifacts/android/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
                echo "å·²å¤åˆ¶: WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
              done
            fi
            
            # å¤„ç† Release APK
            find android/app/build/outputs/apk/release -name "*.apk" -type f 2>/dev/null | while read file; do
              base=$(basename "$file")
              cp "$file" "./artifacts/android/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
              echo "å·²å¤åˆ¶: WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
            done
          fi
          
          # å¤„ç† iOS æ–‡ä»¶
          if [ "${{ needs.prepare.outputs.build_ios }}" = "true" ]; then
            echo "ğŸ“¦ å‡†å¤‡ iOS å‘å¸ƒæ–‡ä»¶..."
            mkdir -p ./artifacts/ios
            
            # å¤„ç† Debug App
            if [ "${{ needs.prepare.outputs.need_debug }}" = "true" ]; then
              if [ -d "ios/build-debug/Build/Products/Debug-iphonesimulator" ]; then
                find ios/build-debug/Build/Products/Debug-iphonesimulator -name "*.app" -type d 2>/dev/null | while read app; do
                  cd "$(dirname "$app")"
                  zip -r "${{ github.workspace }}/artifacts/ios/WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip" "$(basename "$app")"
                  cd "${{ github.workspace }}"
                  echo "å·²åˆ›å»º: WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip"
                done
              fi
            fi
            
            # å¤„ç† Release IPA
            find ios/build-release/output -name "*.ipa" -type f 2>/dev/null | while read file; do
              cp "$file" "./artifacts/ios/WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
              echo "å·²å¤åˆ¶: WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
            done
          fi
          
          # å¤„ç†æˆªå›¾
          if [ -d "screenshots/$APP_NAME" ]; then
            echo "ğŸ“¸ å‡†å¤‡æˆªå›¾..."
            cd screenshots && zip -r "${{ github.workspace }}/artifacts/Screenshots-${{ needs.prepare.outputs.app_version }}.zip" "$APP_NAME"
            cd "${{ github.workspace }}"
            echo "å·²åˆ›å»º: Screenshots-${{ needs.prepare.outputs.app_version }}.zip"
          fi
          
          echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
          ls -lR ./artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## WebView App Release ${{ github.ref_name }}
            
            **Version**: ${{ needs.prepare.outputs.app_version }}
            **Build Mode**: ${{ needs.prepare.outputs.need_debug == 'true' && 'Debug + Release' || 'Release Only' }}
            **Build Type**: ä¸²è¡Œæ„å»º (iOS â†’ Android)
            
            ### What's Included
            
            ${{ needs.prepare.outputs.build_android == 'true' && '- âœ… Android APK' || '- âŒ Android (disabled)' }}
            ${{ needs.prepare.outputs.build_ios == 'true' && '- âœ… iOS IPA/App' || '- âŒ iOS (disabled)' }}
            
            ### Installation
            
            #### Android
            1. ä¸‹è½½ APK æ–‡ä»¶
            2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£… APK
            
            #### iOS (Debug)
            1. ä¸‹è½½ ZIP æ–‡ä»¶å¹¶è§£å‹
            2. ä½¿ç”¨ Xcode æˆ–å…¶ä»–å·¥å…·å®‰è£…åˆ°æ¨¡æ‹Ÿå™¨
            
            #### iOS (Release)
            1. ä¸‹è½½ IPA æ–‡ä»¶
            2. ä½¿ç”¨ Apple Configurator æˆ– TestFlight å®‰è£…åˆ°è®¾å¤‡
            
            ---
            *This release was automatically generated by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            ./artifacts/android/*.apk
            ./artifacts/ios/*.ipa
            ./artifacts/ios/*.zip
            ./artifacts/Screenshots-*.zip
          fail_on_unmatched_files: false
