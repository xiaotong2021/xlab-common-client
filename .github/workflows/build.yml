name: Build WebView App

on:
  push:
    tags:
      - "v*" # Trigger when pushing tags starting with v, e.g. v1.0.0

jobs:
  prepare:
    name: Prepare Build Configuration
    runs-on: ubuntu-latest
    outputs:
      build_android: ${{ steps.config.outputs.build_android }}
      build_ios: ${{ steps.config.outputs.build_ios }}
      is_debug: ${{ steps.config.outputs.is_debug }}
      app_version: ${{ steps.config.outputs.app_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Read build configuration
        id: config
        run: |
          # 读取 build.app
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          echo "App Name: $APP_NAME"
          
          # 读取配置文件
          CONFIG_FILE="assets/$APP_NAME/app.cfg"
          
          # 提取配置值
          BUILD_ANDROID=$(grep '^buildAndroid=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          BUILD_IOS=$(grep '^buildIOS=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          IS_DEBUG=$(grep '^isDebug=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          APP_VERSION=$(grep '^appVersion=' $CONFIG_FILE | cut -d'=' -f2)
          
          echo "build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "build_ios=$BUILD_IOS" >> $GITHUB_OUTPUT
          echo "is_debug=$IS_DEBUG" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          
          echo "Build Android: $BUILD_ANDROID"
          echo "Build iOS: $BUILD_IOS"
          echo "Is Debug: $IS_DEBUG"
          echo "App Version: $APP_VERSION"

  build-android:
    name: Build Android App
    needs: prepare
    if: needs.prepare.outputs.build_android == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Configure project
        run: |
          python3 scripts/build_config.py ${{ github.workspace }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
        working-directory: ./

      - name: Decode and create keystore (Release mode only)
        if: needs.prepare.outputs.is_debug == 'false'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/${{ secrets.ANDROID_KEYSTORE_FILE || 'devdroid.jks' }}
        working-directory: ./

      - name: Build Debug APK
        if: needs.prepare.outputs.is_debug == 'true'
        run: ./gradlew assembleDebug
        working-directory: ./android

      - name: Build Release APK
        if: needs.prepare.outputs.is_debug == 'false'
        run: ./gradlew assembleRelease
        working-directory: ./android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/**/*.apk

  build-ios:
    name: Build iOS App
    needs: prepare
    if: needs.prepare.outputs.build_ios == 'true'
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Configure project
        run: |
          python3 scripts/build_config.py ${{ github.workspace }}

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Create exportOptions.plist (Release mode only)
        if: needs.prepare.outputs.is_debug == 'false'
        run: |
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${{ secrets.IOS_EXPORT_METHOD || 'app-store' }}</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF

      - name: Install certificates and provisioning profiles (Release mode only)
        if: needs.prepare.outputs.is_debug == 'false'
        run: |
          # 创建临时keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # 导入证书
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # 安装provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Build iOS app (Debug)
        if: needs.prepare.outputs.is_debug == 'true'
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Build iOS app (Release)
        if: needs.prepare.outputs.is_debug == 'false'
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            -archivePath build/WebViewApp.xcarchive \
            archive
          
          # 导出IPA
          xcodebuild -exportArchive \
            -archivePath build/WebViewApp.xcarchive \
            -exportPath build/output \
            -exportOptionsPlist exportOptions.plist

      - name: Upload iOS artifacts (Debug)
        if: needs.prepare.outputs.is_debug == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-debug
          path: ios/build/Build/Products/Debug-iphonesimulator/*.app

      - name: Upload iOS artifacts (Release)
        if: needs.prepare.outputs.is_debug == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/output/*.ipa

  release:
    name: Create Release
    needs: [prepare, build-android, build-ios]
    if: |
      always() && 
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-ios.result == 'success' || needs.build-ios.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Android artifacts
        if: needs.prepare.outputs.build_android == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts/android

      - name: Download iOS artifacts (Debug)
        if: needs.prepare.outputs.build_ios == 'true' && needs.prepare.outputs.is_debug == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ios-app-debug
          path: ./artifacts/ios

      - name: Download iOS artifacts (Release)
        if: needs.prepare.outputs.build_ios == 'true' && needs.prepare.outputs.is_debug == 'false'
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./artifacts/ios

      - name: Rename artifacts for release
        run: |
          # 显示下载的文件结构（用于调试）
          echo "=== Downloaded artifacts structure ==="
          ls -lR ./artifacts/ || echo "No artifacts directory found"
          
          # 重命名 Android APK 文件
          if [ -d "./artifacts/android" ]; then
            echo "=== Processing Android artifacts ==="
            find ./artifacts/android -name "*.apk" -type f | while read file; do
              dir=$(dirname "$file")
              base=$(basename "$file")
              echo "Found APK: $file"
              # 重命名为带版本号的文件名
              mv "$file" "$dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
              echo "Renamed to: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
            done
          else
            echo "Warning: No Android artifacts found"
          fi
          
          # 处理 iOS artifacts
          if [ -d "./artifacts/ios" ]; then
            echo "=== Processing iOS artifacts ==="
            # 处理 IPA 文件
            find ./artifacts/ios -name "*.ipa" -type f | while read file; do
              dir=$(dirname "$file")
              echo "Found IPA: $file"
              mv "$file" "$dir/WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
              echo "Renamed to: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
            done
            
            # 压缩 .app 文件
            find ./artifacts/ios -name "*.app" -type d | while read app; do
              dir=$(dirname "$app")
              appname=$(basename "$app" .app)
              echo "Found APP: $app"
              (cd "$dir" && zip -r "WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip" "$(basename "$app")")
              echo "Created ZIP: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip"
              rm -rf "$app"
            done
          else
            echo "Warning: No iOS artifacts found"
          fi
          
          # 显示最终文件列表
          echo "=== Final artifacts ==="
          ls -lR ./artifacts/ || echo "No artifacts"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## WebView App Release ${{ github.ref_name }}
            
            **Version**: ${{ needs.prepare.outputs.app_version }}
            **Build Mode**: ${{ needs.prepare.outputs.is_debug == 'true' && 'Debug' || 'Release' }}
            
            ### What's Included
            
            ${{ needs.prepare.outputs.build_android == 'true' && '- ✅ Android APK' || '- ❌ Android (disabled)' }}
            ${{ needs.prepare.outputs.build_ios == 'true' && '- ✅ iOS IPA/App' || '- ❌ iOS (disabled)' }}
            
            ### Installation
            
            #### Android
            1. 下载 APK 文件
            2. 在设备上启用"未知来源"安装
            3. 安装 APK
            
            #### iOS (Debug)
            1. 下载 ZIP 文件并解压
            2. 使用 Xcode 或其他工具安装到模拟器
            
            #### iOS (Release)
            1. 下载 IPA 文件
            2. 使用 Apple Configurator 或 TestFlight 安装到设备
            
            ---
            *This release was automatically generated by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            ./artifacts/**/*.apk
            ./artifacts/**/*.ipa
            ./artifacts/**/*.zip
          fail_on_unmatched_files: false
