name: Build iOS App

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* tag æ—¶è§¦å‘æ„å»º
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    tags:
      - "v*"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¨å±€å¸¸é‡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  XCODE_VERSION: "15.0.1"
  PROJECT:       "Hamster.xcodeproj"
  SCHEME:        "Hamster"
  HAMSTER_DIR:   "Hamster"

jobs:
  # ============================================================================
  # Job 1 â”€â”€ è¯»å–æ„å»ºé…ç½®
  # ============================================================================
  prepare:
    name: Prepare Build Configuration
    runs-on: ubuntu-latest
    outputs:
      need_debug: ${{ steps.config.outputs.need_debug }}
      app_version: ${{ steps.config.outputs.app_version }}
      app_display_name: ${{ steps.config.outputs.app_display_name }}
      bundle_id: ${{ steps.config.outputs.bundle_id }}
      bundle_id_keyboard: ${{ steps.config.outputs.bundle_id_keyboard }}
      team_id: ${{ steps.config.outputs.team_id }}
      export_method: ${{ steps.config.outputs.export_method }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Read build configuration
        id: config
        env:
          SECRET_BUNDLE_ID:          ${{ secrets.IOS_BUNDLE_ID }}
          SECRET_BUNDLE_ID_KEYBOARD: ${{ secrets.IOS_BUNDLE_ID_KEYBOARD }}
          SECRET_TEAM_ID:            ${{ secrets.IOS_TEAM_ID }}
          SECRET_EXPORT_METHOD:      ${{ secrets.IOS_EXPORT_METHOD }}
        run: |
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          CONFIG_FILE="assets/$APP_NAME/app.cfg"

          # ä»é…ç½®æ–‡ä»¶è¯»å–å€¼
          CFG_NEED_DEBUG=$(grep '^needDebug=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          CFG_APP_VERSION=$(grep '^appVersion=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_APP_DISPLAY_NAME=$(grep '^appDisplayName=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_BUNDLE_ID=$(grep '^appId=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_TEAM_ID=$(grep '^iosTeamId=' $CONFIG_FILE | cut -d'=' -f2)
          CFG_EXPORT_METHOD=$(grep '^iosExportMethod=' $CONFIG_FILE | cut -d'=' -f2)

          # ä¼˜å…ˆä½¿ç”¨ GitHub Secretsï¼Œæœªè®¾ç½®åˆ™å›é€€åˆ°é…ç½®æ–‡ä»¶
          NEED_DEBUG=${CFG_NEED_DEBUG:-false}
          APP_VERSION=$CFG_APP_VERSION
          APP_DISPLAY_NAME=$CFG_APP_DISPLAY_NAME
          BUNDLE_ID=${SECRET_BUNDLE_ID:-$CFG_BUNDLE_ID}
          TEAM_ID=${SECRET_TEAM_ID:-$CFG_TEAM_ID}
          EXPORT_METHOD=${SECRET_EXPORT_METHOD:-${CFG_EXPORT_METHOD:-app-store}}
          BUNDLE_ID_KEYBOARD=${SECRET_BUNDLE_ID_KEYBOARD:-${BUNDLE_ID}.HamsterKeyboard}

          echo "need_debug=$NEED_DEBUG"                    >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION"                  >> $GITHUB_OUTPUT
          echo "app_display_name=$APP_DISPLAY_NAME"        >> $GITHUB_OUTPUT
          echo "bundle_id=$BUNDLE_ID"                      >> $GITHUB_OUTPUT
          echo "bundle_id_keyboard=$BUNDLE_ID_KEYBOARD"    >> $GITHUB_OUTPUT
          echo "team_id=$TEAM_ID"                          >> $GITHUB_OUTPUT
          echo "export_method=$EXPORT_METHOD"              >> $GITHUB_OUTPUT

          echo "Need Debug: $NEED_DEBUG"
          echo "App Version: $APP_VERSION"
          echo "App Display Name: $APP_DISPLAY_NAME"
          echo "Bundle ID: $BUNDLE_ID (source: $([ -n "$SECRET_BUNDLE_ID" ] && echo 'secrets' || echo 'app.cfg'))"
          echo "Bundle ID Keyboard: $BUNDLE_ID_KEYBOARD (source: $([ -n "$SECRET_BUNDLE_ID_KEYBOARD" ] && echo 'secrets' || echo 'derived'))"
          echo "Team ID: $TEAM_ID (source: $([ -n "$SECRET_TEAM_ID" ] && echo 'secrets' || echo 'app.cfg'))"
          echo "Export Method: $EXPORT_METHOD (source: $([ -n "$SECRET_EXPORT_METHOD" ] && echo 'secrets' || echo 'app.cfg'))"

  # ============================================================================
  # Job 2 â”€â”€ iOS æ„å»ºï¼ˆDebug + Releaseï¼‰+ GitHub Release
  #
  #  æ‰€éœ€ GitHub Secretsï¼ˆå¿…å¡«ï¼‰:
  #    KEYCHAIN_PASSWORD                        ä¸´æ—¶ keychain å¯†ç ï¼ˆä»»æ„å­—ç¬¦ä¸²ï¼‰
  #    IOS_CERTIFICATE_BASE64                   å‘å¸ƒè¯ä¹¦ .p12 çš„ base64 ç¼–ç 
  #    IOS_CERTIFICATE_PASSWORD                 .p12 è¯ä¹¦çš„ä¿æŠ¤å¯†ç 
  #    IOS_PROVISIONING_PROFILE_BASE64          ä¸» App æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #    IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 é”®ç›˜æ‰©å±•æè¿°æ–‡ä»¶ .mobileprovision çš„ base64
  #    TOKEN                                    GitHub Tokenï¼ˆç”¨äº Releaseï¼‰
  #
  #  å¯é€‰ GitHub Secretsï¼ˆä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ï¼Œæœªè®¾ç½®åˆ™å›é€€åˆ° app.cfgï¼‰:
  #    IOS_BUNDLE_ID            â†’ Bundle IDï¼ˆä¸» Appï¼‰ï¼Œå›é€€: appId
  #    IOS_BUNDLE_ID_KEYBOARD   â†’ Bundle IDï¼ˆé”®ç›˜æ‰©å±•ï¼‰ï¼Œå›é€€: ${BUNDLE_ID}.HamsterKeyboard
  #    IOS_TEAM_ID              â†’ Apple å¼€å‘è€… Team IDï¼Œå›é€€: iosTeamId
  #    IOS_EXPORT_METHOD        â†’ å¯¼å‡ºæ–¹å¼ï¼Œå›é€€: iosExportMethod
  # ============================================================================
  build:
    name: Build Hamster iOS App
    needs: prepare
    runs-on: macos-13
    permissions:
      contents: write

    steps:
      # â”€â”€ æ‹‰å–ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      # â”€â”€ åˆ‡æ¢ Xcode ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s "/Applications/Xcode_${{ env.XCODE_VERSION }}.app"

      # â”€â”€ æ ¡éªŒ Frameworks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Frameworks
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          required=(
            "boost_atomic.xcframework"   "boost_filesystem.xcframework"
            "boost_locale.xcframework"   "boost_regex.xcframework"
            "boost_system.xcframework"   "icudata.xcframework"
            "icui18n.xcframework"        "icuio.xcframework"
            "icuuc.xcframework"          "libglog.xcframework"
            "libleveldb.xcframework"     "libmarisa.xcframework"
            "libopencc.xcframework"      "librime.xcframework"
            "librime-sbxlm.xcframework"  "libyaml-cpp.xcframework"
          )
          missing=()
          for fw in "${required[@]}"; do
            [ -d "Frameworks/$fw" ] && echo "  âœ“ $fw" || { echo "  âœ— $fw â† MISSING"; missing+=("$fw"); }
          done
          [ ${#missing[@]} -eq 0 ] && echo "âœ… æ‰€æœ‰ xcframework å°±ç»ª" || { echo "âŒ ç¼ºå¤±: ${missing[*]}"; exit 1; }

      # â”€â”€ ç¼–è¯‘è¾“å…¥æ–¹æ¡ˆï¼ˆrime-ice ç­‰ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Schemas
        working-directory: ${{ env.HAMSTER_DIR }}
        run: make schema

      # â”€â”€ æ¸…ç† DerivedData â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      # ========== iOS Debug æ„å»ºï¼ˆæ¨¡æ‹Ÿå™¨ï¼Œæ— éœ€ç­¾åï¼‰ ==========
      - name: Build Debug (Simulator)
        if: needs.prepare.outputs.need_debug == 'true'
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild build \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package Debug .app
        if: needs.prepare.outputs.need_debug == 'true'
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          APP_PATH=$(find build-debug -name "*.app" -not -path "*/PlugIns/*" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° .app ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          echo "ğŸ“¦ æ‰“åŒ…: $APP_PATH"
          zip -r Hamster-Debug-Simulator.zip "$APP_PATH"

      # ========== iOS Release æ„å»ºï¼ˆçœŸæœºç­¾åï¼‰ ==========
      - name: Install Certificate & Provisioning Profiles
        env:
          CERTIFICATE_BASE64:      ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD:    ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROFILE_MAIN_BASE64:     ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          PROFILE_KEYBOARD_BASE64: ${{ secrets.IOS_KEYBOARD_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD:       ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # â”€â”€ åˆ›å»ºä¸´æ—¶ keychain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain  -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # â”€â”€ å¯¼å…¥ .p12 è¯ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # â”€â”€ å®‰è£…ä¸» App Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo "$PROFILE_MAIN_BASE64" | base64 --decode > profile_main.mobileprovision
          MAIN_UUID=$(security cms -D -i profile_main.mobileprovision | plutil -extract UUID raw -)
          MAIN_NAME=$(security cms -D -i profile_main.mobileprovision | plutil -extract Name raw -)
          cp profile_main.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/${MAIN_UUID}.mobileprovision
          echo "ä¸» App Profile: $MAIN_NAME (UUID: $MAIN_UUID)"

          # â”€â”€ å®‰è£…é”®ç›˜æ‰©å±• Provisioning Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "$PROFILE_KEYBOARD_BASE64" | base64 --decode > profile_keyboard.mobileprovision
          KEYBOARD_UUID=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract UUID raw -)
          KEYBOARD_NAME=$(security cms -D -i profile_keyboard.mobileprovision | plutil -extract Name raw -)
          cp profile_keyboard.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/${KEYBOARD_UUID}.mobileprovision
          echo "é”®ç›˜æ‰©å±• Profile: $KEYBOARD_NAME (UUID: $KEYBOARD_UUID)"

          # â”€â”€ è·å–è¯ä¹¦ç­¾åèº«ä»½ï¼ˆSHA-1ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          CERT_IDENTITY=$(
            security find-identity -v -p codesigning build.keychain \
            | grep -E "Apple Distribution|iPhone Distribution" \
            | head -1 | awk '{print $2}'
          )
          if [ -z "$CERT_IDENTITY" ]; then
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ Distribution è¯ä¹¦"
            security find-identity -v build.keychain
            exit 1
          fi
          echo "è¯ä¹¦ Identity: $CERT_IDENTITY"

          # â”€â”€ å†™å…¥ GITHUB_ENV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "MAIN_PROFILE_NAME=$MAIN_NAME"         >> $GITHUB_ENV
          echo "KEYBOARD_PROFILE_NAME=$KEYBOARD_NAME" >> $GITHUB_ENV
          echo "CERT_IDENTITY=$CERT_IDENTITY"         >> $GITHUB_ENV

      # å½’æ¡£é˜¶æ®µä¸ç­¾åï¼Œç­¾ååœ¨ exportArchive ç»Ÿä¸€å®Œæˆã€‚
      # è¿™æ ·å¯ä»¥ä¸ºä¸åŒ targetï¼ˆä¸» App / é”®ç›˜æ‰©å±•ï¼‰æŒ‡å®šä¸åŒ profileã€‚
      - name: Archive (unsigned)
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild archive \
            -project "${{ env.PROJECT }}" \
            -scheme  "${{ env.SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            -archivePath Hamster.xcarchive \
            CODE_SIGNING_ALLOWED=NO

      - name: Generate exportOptions.plist
        working-directory: ${{ env.HAMSTER_DIR }}
        env:
          EXPORT_METHOD: ${{ needs.prepare.outputs.export_method }}
          TEAM_ID:       ${{ needs.prepare.outputs.team_id }}
          BUNDLE_ID:     ${{ needs.prepare.outputs.bundle_id }}
          BUNDLE_ID_KB:  ${{ needs.prepare.outputs.bundle_id_keyboard }}
        run: |
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${EXPORT_METHOD}</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${MAIN_PROFILE_NAME}</string>
                  <key>${BUNDLE_ID_KB}</key>
                  <string>${KEYBOARD_PROFILE_NAME}</string>
              </dict>
          </dict>
          </plist>
          EOF

          echo "â”€â”€ exportOptions.plist â”€â”€"
          cat exportOptions.plist

      - name: Export IPA
        working-directory: ${{ env.HAMSTER_DIR }}
        run: |
          xcodebuild -exportArchive \
            -archivePath Hamster.xcarchive \
            -exportPath  Hamster-Release \
            -exportOptionsPlist exportOptions.plist
          echo "â”€â”€ å¯¼å‡ºäº§ç‰© â”€â”€"
          ls -lh Hamster-Release/

      # â”€â”€ æ‰“åŒ… xcarchiveï¼ˆå¯åœ¨ Xcode Organizer ä¸­é‡æ–°å¯¼å‡ºæˆ– resignï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package xcarchive
        working-directory: ${{ env.HAMSTER_DIR }}
        run: tar -acf Hamster.xcarchive.tgz Hamster.xcarchive

      # ========== å‡†å¤‡å‘å¸ƒäº§ç‰© ==========
      - name: Prepare release artifacts
        run: |
          mkdir -p ./artifacts

          # Debug .app zip
          if [ "${{ needs.prepare.outputs.need_debug }}" = "true" ]; then
            if [ -f "${{ env.HAMSTER_DIR }}/Hamster-Debug-Simulator.zip" ]; then
              cp "${{ env.HAMSTER_DIR }}/Hamster-Debug-Simulator.zip" \
                "./artifacts/Hamster-${{ needs.prepare.outputs.app_version }}-Debug-Simulator.zip"
              echo "å·²åˆ›å»º: Hamster-${{ needs.prepare.outputs.app_version }}-Debug-Simulator.zip"
            fi
          fi

          # Release IPA
          find "${{ env.HAMSTER_DIR }}/Hamster-Release" -name "*.ipa" -type f 2>/dev/null | while read file; do
            cp "$file" "./artifacts/Hamster-${{ needs.prepare.outputs.app_version }}.ipa"
            echo "å·²å¤åˆ¶: Hamster-${{ needs.prepare.outputs.app_version }}.ipa"
          done

          # xcarchive
          if [ -f "${{ env.HAMSTER_DIR }}/Hamster.xcarchive.tgz" ]; then
            cp "${{ env.HAMSTER_DIR }}/Hamster.xcarchive.tgz" \
              "./artifacts/Hamster-${{ needs.prepare.outputs.app_version }}.xcarchive.tgz"
            echo "å·²å¤åˆ¶: Hamster-${{ needs.prepare.outputs.app_version }}.xcarchive.tgz"
          fi

          echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
          ls -lR ./artifacts/

      # ========== GitHub Release ==========
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: "${{ needs.prepare.outputs.app_display_name }} ${{ github.ref_name }}"
          body: |
            ## ${{ needs.prepare.outputs.app_display_name }} ${{ github.ref_name }}

            **ç‰ˆæœ¬å· / Version**: ${{ needs.prepare.outputs.app_version }}

            ### ğŸ“¦ å®‰è£…æ–¹å¼
            | å¯¼å‡ºæ–¹å¼ | å®‰è£…é€”å¾„ |
            |----------|---------|
            | `app-store` | TestFlight å†…æµ‹ / App Store æ­£å¼å‘å¸ƒ |
            | `ad-hoc`    | AltStore / Sideloadly ç­‰å·¥å…·ä¾§è½½ |
            | `development` | Xcode ç›´æ¥å®‰è£…åˆ°å·²æ³¨å†Œçš„å¼€å‘è®¾å¤‡ |

            ### ğŸ“ æ–‡ä»¶è¯´æ˜
            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `Hamster-*.ipa` | iOS å®‰è£…åŒ… |
            | `Hamster-*-Debug-Simulator.zip` | æ¨¡æ‹Ÿå™¨ Debug åŒ…ï¼ˆä»…å¼€å¯ debug æ—¶ç”Ÿæˆï¼‰ |
            | `Hamster-*.xcarchive.tgz` | Xcode å½’æ¡£ï¼Œå¯é‡æ–°å¯¼å‡ºæˆ– resign |

            ### ğŸ“ å˜æ›´å†…å®¹
            è¯¦è§ [Commits](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          draft: false
          prerelease: false
          files: |
            ./artifacts/Hamster-*.ipa
            ./artifacts/Hamster-*-Debug-Simulator.zip
            ./artifacts/Hamster-*.xcarchive.tgz
          fail_on_unmatched_files: false
