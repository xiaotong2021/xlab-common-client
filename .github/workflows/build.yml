name: Build WebView App

on:
  push:
    tags:
      - "v*" # Trigger when pushing tags starting with v, e.g. v1.0.0

jobs:
  prepare:
    name: Prepare Build Configuration
    runs-on: ubuntu-latest
    outputs:
      build_android: ${{ steps.config.outputs.build_android }}
      build_ios: ${{ steps.config.outputs.build_ios }}
      need_debug: ${{ steps.config.outputs.need_debug }}
      app_version: ${{ steps.config.outputs.app_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Read build configuration
        id: config
        run: |
          # 读取 build.app
          APP_NAME=$(grep 'appName=' assets/build.app | cut -d'=' -f2)
          echo "App Name: $APP_NAME"
          
          # 读取配置文件
          CONFIG_FILE="assets/$APP_NAME/app.cfg"
          
          # 提取配置值
          BUILD_ANDROID=$(grep '^buildAndroid=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          BUILD_IOS=$(grep '^buildIOS=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          NEED_DEBUG=$(grep '^needDebug=' $CONFIG_FILE | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
          APP_VERSION=$(grep '^appVersion=' $CONFIG_FILE | cut -d'=' -f2)
          
          # 设置默认值
          NEED_DEBUG=${NEED_DEBUG:-false}
          
          echo "build_android=$BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "build_ios=$BUILD_IOS" >> $GITHUB_OUTPUT
          echo "need_debug=$NEED_DEBUG" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          
          echo "Build Android: $BUILD_ANDROID"
          echo "Build iOS: $BUILD_IOS"
          echo "Need Debug: $NEED_DEBUG"
          echo "App Version: $APP_VERSION"

  build-android:
    name: Build Android App
    needs: prepare
    if: needs.prepare.outputs.build_android == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          pip install Pillow

      - name: Configure project
        run: |
          python3 scripts/build_config.py ${{ github.workspace }}

      - name: Verify build configuration
        run: |
          chmod +x scripts/verify_build.sh
          bash scripts/verify_build.sh

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
        working-directory: ./

      - name: Clean Android build
        run: ./gradlew clean
        working-directory: ./android

      - name: Decode and create keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/${{ secrets.ANDROID_KEYSTORE_FILE || 'devdroid.jks' }}
        working-directory: ./

      - name: Build Debug APK
        if: needs.prepare.outputs.need_debug == 'true'
        run: ./gradlew assembleDebug
        working-directory: ./android

      - name: Build Release APK
        run: ./gradlew assembleRelease
        working-directory: ./android
        env:
          KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE || 'devdroid.jks' }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload Android Debug APK
        if: needs.prepare.outputs.need_debug == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: android/app/build/outputs/apk/debug/*.apk

      - name: Upload Android Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: android/app/build/outputs/apk/release/*.apk

  build-ios:
    name: Build iOS App
    needs: prepare
    if: needs.prepare.outputs.build_ios == 'true'
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          pip install Pillow

      - name: Configure project
        run: |
          python3 scripts/build_config.py ${{ github.workspace }}

      - name: Verify build configuration (iOS)
        run: |
          chmod +x scripts/verify_build.sh
          bash scripts/verify_build.sh

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Create exportOptions.plist placeholder
        run: |
          # exportOptions.plist 将在证书安装后创建
          echo "exportOptions.plist will be created after certificate installation"

      - name: Install certificates and provisioning profiles

        run: |
          # 创建临时keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # 导入证书
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # 安装provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          
          # 获取 Profile UUID（使用 security 命令解析）
          PROFILE_UUID=$(security cms -D -i profile.mobileprovision | plutil -extract UUID raw -)
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "Installed Profile UUID: $PROFILE_UUID"
          
          # 获取 Bundle ID（从 Profile 中提取，去掉 Team ID 前缀）
          # application-identifier 格式: TEAMID.com.example.app
          # 使用 sed 删除第一个点之前的内容（Team ID）
          BUNDLE_ID=$(security cms -D -i profile.mobileprovision | plutil -extract Entitlements.application-identifier raw - | sed 's/^[^.]*\.//')
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
          echo "Bundle ID from Profile: $BUNDLE_ID"
          
          # 复制 Profile 到正确的位置（使用 UUID 作为文件名）
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          
          # 列出所有可用的签名身份（用于调试）
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          
          # 获取证书身份（SHA-1 hash）
          CERT_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Apple Distribution" | head -1 | awk '{print $2}')
          echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
          echo "Certificate Identity: $CERT_IDENTITY"
          
          # 如果没有找到 Apple Distribution，尝试查找 iPhone Distribution
          if [ -z "$CERT_IDENTITY" ]; then
            CERT_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "iPhone Distribution" | head -1 | awk '{print $2}')
            echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
            echo "Certificate Identity (iPhone): $CERT_IDENTITY"
          fi
          
          # 创建 exportOptions.plist（包含 provisioningProfiles）
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>${{ secrets.IOS_EXPORT_METHOD || 'app-store' }}</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${PROFILE_UUID}</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          echo "Created exportOptions.plist:"
          cat ios/exportOptions.plist

      - name: Build iOS app (Debug)
        if: needs.prepare.outputs.need_debug == 'true'
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build-debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Build iOS app (Release)
        run: |
          cd ios
          xcodebuild -project WebViewApp.xcodeproj \
            -scheme WebViewApp \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build-release \
            -archivePath build-release/WebViewApp.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="${CERT_IDENTITY}" \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_UUID}" \
            archive
          
          # 导出IPA
          xcodebuild -exportArchive \
            -archivePath build-release/WebViewApp.xcarchive \
            -exportPath build-release/output \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates

      - name: Upload to TestFlight
        run: |
          # 创建私钥目录
          mkdir -p ~/.appstoreconnect/private_keys
          
          # 解码 API 密钥并保存到正确的位置和文件名
          echo "${{ secrets.APP_STORE_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_API_KEY_ID }}.p8
          
          # 设置文件权限
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_API_KEY_ID }}.p8
          
          # 上传 IPA
          xcrun altool --upload-app \
            --file ios/build-release/output/WebViewApp.ipa \
            --type ios \
            --apiKey ${{ secrets.APP_STORE_API_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_API_ISSUER_ID }}

      - name: Upload iOS Debug App
        if: needs.prepare.outputs.need_debug == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-debug
          path: ios/build-debug/Build/Products/Debug-iphonesimulator/*.app

      - name: Upload iOS Release IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-release
          path: ios/build-release/output/*.ipa

  release:
    name: Create Release
    needs: [prepare, build-android, build-ios]
    if: |
      always() && 
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-ios.result == 'success' || needs.build-ios.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Android Debug APK
        if: needs.prepare.outputs.build_android == 'true' && needs.prepare.outputs.need_debug == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk-debug
          path: ./artifacts/android/debug
        continue-on-error: true

      - name: Download Android Release APK
        if: needs.prepare.outputs.build_android == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release
          path: ./artifacts/android/release

      - name: Download iOS Debug App
        if: needs.prepare.outputs.build_ios == 'true' && needs.prepare.outputs.need_debug == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ios-app-debug
          path: ./artifacts/ios/debug
        continue-on-error: true

      - name: Download iOS Release IPA
        if: needs.prepare.outputs.build_ios == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa-release
          path: ./artifacts/ios/release

      - name: Rename artifacts for release
        run: |
          # 显示下载的文件结构（用于调试）
          echo "=== Downloaded artifacts structure ==="
          ls -lR ./artifacts/ || echo "No artifacts directory found"
          
          # 重命名 Android APK 文件
          if [ -d "./artifacts/android" ]; then
            echo "=== Processing Android artifacts ==="
            find ./artifacts/android -name "*.apk" -type f | while read file; do
              dir=$(dirname "$file")
              base=$(basename "$file")
              echo "Found APK: $file"
              # 重命名为带版本号的文件名
              mv "$file" "$dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
              echo "Renamed to: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-${base}"
            done
          else
            echo "Warning: No Android artifacts found"
          fi
          
          # 处理 iOS artifacts
          if [ -d "./artifacts/ios" ]; then
            echo "=== Processing iOS artifacts ==="
            # 处理 IPA 文件
            find ./artifacts/ios -name "*.ipa" -type f | while read file; do
              dir=$(dirname "$file")
              echo "Found IPA: $file"
              mv "$file" "$dir/WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
              echo "Renamed to: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}.ipa"
            done
            
            # 压缩 .app 文件
            find ./artifacts/ios -name "*.app" -type d | while read app; do
              dir=$(dirname "$app")
              appname=$(basename "$app" .app)
              echo "Found APP: $app"
              (cd "$dir" && zip -r "WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip" "$(basename "$app")")
              echo "Created ZIP: $dir/WebViewApp-${{ needs.prepare.outputs.app_version }}-Debug.zip"
              rm -rf "$app"
            done
          else
            echo "Warning: No iOS artifacts found"
          fi
          
          # 显示最终文件列表
          echo "=== Final artifacts ==="
          ls -lR ./artifacts/ || echo "No artifacts"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## WebView App Release ${{ github.ref_name }}
            
            **Version**: ${{ needs.prepare.outputs.app_version }}
            **Build Mode**: ${{ needs.prepare.outputs.need_debug == 'true' && 'Debug + Release' || 'Release Only' }}
            
            ### What's Included
            
            ${{ needs.prepare.outputs.build_android == 'true' && '- ✅ Android APK' || '- ❌ Android (disabled)' }}
            ${{ needs.prepare.outputs.build_ios == 'true' && '- ✅ iOS IPA/App' || '- ❌ iOS (disabled)' }}
            
            ### Installation
            
            #### Android
            1. 下载 APK 文件
            2. 在设备上启用"未知来源"安装
            3. 安装 APK
            
            #### iOS (Debug)
            1. 下载 ZIP 文件并解压
            2. 使用 Xcode 或其他工具安装到模拟器
            
            #### iOS (Release)
            1. 下载 IPA 文件
            2. 使用 Apple Configurator 或 TestFlight 安装到设备
            
            ---
            *This release was automatically generated by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            ./artifacts/**/*.apk
            ./artifacts/**/*.ipa
            ./artifacts/**/*.zip
          fail_on_unmatched_files: false
